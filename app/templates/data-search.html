{% extends "base.html" %}

{% block script %}
{#<script src="{{ url_for('static', filename='js/data-search.js' ) }}"/></script>#}
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
<script>
 document.addEventListener('DOMContentLoaded', function () {

   const gridWrapper = document.getElementById('grid-wrapper');
   const listWrapper = document.getElementById('list-wrapper');
   const galleryWrapper = document.getElementById('gallery-wrapper');
   const listTemplate = document.querySelector('#list-template');
   const galleryTemplate = document.querySelector('#gallery-template');
   const resultsCount = document.getElementById('results-count');
   const searchButton = document.getElementById('search-btn');
   const filterButton = document.getElementById('filter-btn');
   const mainSearch = document.getElementById('main-search');

   // drawer-filter
   const filterForm = document.getElementById('filter-form');
   const applyFilterButton = document.getElementById('apply-filter-btn');

   let searchParams = new URLSearchParams(document.location.search);
   let state = {
     'page': 0,
     'numPerPage': 50,
   };
   let q = searchParams.get('q');
   if (q !== '') {
     mainSearch.value = q;
   }

   applyFilterButton.onclick = (e) => {
     e.preventDefault();
     applyFilter();
   }

   searchButton.onclick = (e) => {
     e.preventDefault();
     //payload.q = mainSearch.value;
     applyFilter();
   };

   function getServerConfig() {
     let serverConfig = {
       headers: {
         'Content-Type': 'application/json',
       },
       url: url,
       then: (resp) => {
         fetchedRows = [...resp.data];
         listWrapper.innerHTML = '';
         galleryWrapper.innerHTML = '';
         console.log(resp);
         document.getElementById('results-title').textContent = '';
         let mapData = {
           center: [0, 0],
           data: [],
         };

         resp.data.forEach( row => {
           if (row.longitude_decimal && row.latitude_decimal) {
             let x = parseFloat(row.longitude_decimal);
             let y = parseFloat(row.latitude_decimal);
             mapData.center[0] += y;
             mapData.center[1] += x;
             mapData.data.push({
               'xy': [y, x],
             });
           }
         });
         mapData.center[0] = mapData.center[0] / mapData.data.length;
         mapData.center[1] = mapData.center[1] / mapData.data.length;
         console.log(mapData);
         if (mapData.center[0] && mapData.center[1]) {
           //renderMap(mapData);
         }

         let startIndex = state.page*state.numPerPage;
         let end = Math.min((startIndex)+resp.data.length, (state.page+1)*state.numPerPage);
         resultsCount.textContent = `顯示第 ${startIndex+1} 到第 ${end} 筆，共 ${resp.total} 筆資料 (${resp.elapsed.toFixed(4)} 秒)`;
         return resp.data.map( (row, index)  => {
           const clone = listTemplate.content.cloneNode(true);
           const clone2 = galleryTemplate.content.cloneNode(true);
           let listViewScientificName = clone.querySelector('.list-view-scientific-name');
           let listViewCommonName = clone.querySelector('.list-view-common-name');
           let listViewGathering = clone.querySelector('.list-view-gathering');
           let listViewAccessionNumber = clone.querySelector('.list-view-accession-number');
           let listViewCollectDate = clone.querySelector('.list-view-collect-date');
           let listViewLocality = clone.querySelector('.list-view-locality');
           let listViewImage = clone.querySelector('.list-view-image');
           let listViewLink = clone.querySelector('.list-view-link');
           let galleryViewImage = clone2.querySelector('.gallery-view-image');
           let galleryViewLink = clone2.querySelector('.gallery-view-link');

           listViewScientificName.textContent = (row.taxon) ? row.taxon.full_scientific_name : '';
           listViewCommonName.textContent = (row.taxon) ? row.taxon.common_name : '';
           listViewGathering.textContent = `${row.collector ? row.collector.display_name : ''} ${row.field_number}`;
           let localityList = row.named_areas.map( x => (x.display_name))
           if (row.locality_text) {
             localityList.push(row.locality_text);
           }
           listViewLocality.textContent = localityList.join(' ∙ ');
           listViewCollectDate.textContent = row.collect_date;
           listViewAccessionNumber.textContent = `HAST:${row.accession_number}`;
           listViewImage.setAttribute('alt', `HAST:${row.accession_number}`);
           if (row.image_url) {
             listViewImage.src = row.image_url;
             galleryViewImage.src = row.image_url;
           }
           listViewLink.href = row.link;
           galleryViewImage.setAttribute('alt', `HAST:${row.accession_number}`);
           galleryViewLink.href = row.link;
           listWrapper.appendChild(clone);
           galleryWrapper.appendChild(clone2);

           return {
             //id: row.record_key,
             image_url: row.image_url || '',
             accession_number: row.accession_number,
             collector: (row.collector) || '',
             field_number: row.field_number,
             taxon: (row.taxon) ? row.taxon : {},
             collect_date: row.collect_date,
             locality: localityList.join(' ∙ '),
             link: row.link,
           }
         });
       },
       total: (resp) =>  resp.total,
       handle: (res) => {
         // no matching records found
         if (res.status === 404) return {data: []};
         if (res.ok) return res.json();
         throw Error('oh no :(');
       },
     }; // end of serverConfig
     return serverConfig;
   }

   // === config grid ===
   const baseUrl = new URL(`{{ SEARCH_API_URL }}api/v1/search`);
   let url = baseUrl.toString();
   if (searchParams.has('q')) {
     let data = {
       q: searchParams.get('q'),
     }
     url = `${url}?filter=${JSON.stringify(data)}`;
   }

   let limit = state.numPerPage;
   let columnsConfig = [
     {id: 'image_url', name: '{{ _("標本照") }}', formatter: (cell) => {
       if (cell) {
         return gridjs.html(`<img src="${cell.replace('-m.jpg', '-s.jpg')}" width="45px" />`);
       }
     }, sort: false},
     {id: 'accession_number', name: '{{ _("館號") }}', formatter: (cell) => {
       return gridjs.html(`<strong>${cell}</strong>`);
     }},
     {id: 'taxon', name: '{{ _("物種") }}', formatter: (cell) => {
       return gridjs.html(`${cell.full_scientific_name || ''}<br /><span class="text-gray-600">${cell.common_name || ''}</span>`);
     }, sort: false},
     {id: 'collector', name: '{{ _("採集者") }}', formatter: (cell) => {
       return gridjs.html(`${cell.full_name_en || ''}<br /><span class="text-gray-600">${cell.full_name || ''}</span>`);
     }},
     {id: 'field_number', name: '{{ _("採集號") }}'},
     {id: 'collect_date', name: '{{ _("採集日期") }}'},
     {id: 'locality', name: '{{ _("採集地點") }}', sort: false},
     {id: 'link', name: '{{ _("連結") }}', sort: false, formatter: (cell, row) => {
       return gridjs.html(`<a href="${cell}" class="text-green-600 hover:text-green-800 font-semibold text-sm">{{ _('連結') }}</a>`);
     }},
   ];

   let paginationServer = {
     url: (prev, page, limit) => {
       state.page = page
       return `${prev}${prev.includes('?') ? '&' : '?'}range=${JSON.stringify([page * limit, (page + 1 ) * limit])}`;
     },
   };
   let sortServer = {
     url: (prev, cols) => {
       //console.log(prev, cols, typeof(prev));
       if (!cols.length) return prev;

       const col = cols[0];
       let field = columnsConfig[col.index].id;
       field = (col.direction === 1) ? field : `-${field}`;
       return `${prev}${prev.includes('?') ? '&' : '?'}sort=${JSON.stringify([field])}`;
     }
   };
   let gridConfig = {
     //server: serverConfig,
     columns: columnsConfig,
     resizable: true,
     data: [],
     pagination: {
       enabled: true,
       limit: limit,
     },
     sort: {
       multiColumn: false,
     },
   };
   /*
     gridConfig.search = {
       debounceTimeout: 400,
       server: {
         url: (prev, q) => {
           return `${prev}${prev.includes('?') ? '&' : '?'}filter=${JSON.stringify({'q':q})}`;
         }
       }
     };
   */
   const grid  = new gridjs.Grid(gridConfig).render(gridWrapper);

   const getFormData = () => {
     const formData = new FormData(filterForm);
     let data = {};
     for (const [key, value] of formData) {
       if (value) {
         if (['species', 'genus', 'family', 'adm1', 'adm2', 'adm3'].indexOf(key) < 0) {
           data[key] = value;
         }
       }
     }
     let col = formData.get('collector');
     if (col) {
      data.collector_id = col;
     }
     // taxon_id
     const taxa = ['species', 'genus', 'family'];
     for(let i=0; i<taxa.length; i++) {
       if (formData.has(taxa[i]) && formData.get(taxa[i])) {
         data.taxon_id = formData.get(taxa[i]);
         break;
       }
     }
     // named_area_id
     const namedAreas = ['adm3', 'adm2', 'adm1'];
     for(let i=0; i<namedAreas.length; i++) {
       if (formData.has(namedAreas[i]) && formData.get(namedAreas[i])) {
         data.named_area_id = formData.get(namedAreas[i]);
         break;
       }
     }

     return data;
   };

   const applyFilter = () => {
     resultsCount.innerHTML = '';
     document.getElementById('results-title').textContent = 'Loading...';
     let data = getFormData();
     if (mainSearch.value !== '') {
       data.q = mainSearch.value;
     }
     //alert(JSON.stringify(data, null, 2));
     if (Object.keys(data).length) {
       filterButton.classList.remove('bg-white', 'hover:bg-gray-50');
       filterButton.classList.add('bg-purple-700', 'hover:bg-purple-800', 'text-white');
     } else {
       filterButton.classList.remove('bg-purple-700', 'hover:bg-purple-800', 'text-white');
       filterButton.classList.add('bg-white', 'hover:bg-gray-50');
     }
     //q
     let serverConfig = getServerConfig();
     let url = `${baseUrl}?filter=${JSON.stringify(data)}`;

     grid.updateConfig({
       server: {
         ...serverConfig,
         url: url,
       },
       pagination: {
         ...gridConfig.pagination,
         server: paginationServer,
       },
       sort: {
         ...gridConfig.server,
         server: sortServer,
       }
     }).forceRender();
   };

   let mapEntity = null;
   const renderMap = (data) => {
     if (mapEntity) {
       mapEntity.remove();
     }
     mapEntity = L.map('result-map').setView(data.center, 13);
     L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
     }).addTo(mapEntity);

     // Add marker for collection location
     {#
       L.marker([{{ data.info.location.coordinate_dd.y }}, {{ data.info.location.coordinate_dd.x }}])
        .addTo(mapEntity)
        .bindPopup('<b>Collection Site</b><br>Stockholm, Sweden<br>Collected by C. Linnaeus, 1753')
        .openPopup();
       #}
   }

 });
</script>
{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
 #result-map {
   height: 500px;
   /*width: 960px;*/
   width: auto;
   border-radius: 0.5rem;
   z-index: 10;
  }
</style>
{% endblock %}

{% block main %}
<main class="pt-24">

  <!-- Search Header Section -->
  <section class="bg-white border-b border-gray-200 py-6">
    <div class="max-w-screen-xl mx-auto px-4">
      <header class="text-center mb-6">
        <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 sm:text-5xl">
          {{ _('標本搜尋') }}
        </h1>
      </header>

      <!-- Search Form -->
      <form id="search-form" class="flex flex-col lg:flex-row gap-4 max-w-4xl mx-auto">
        <div class="relative flex-1">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <input
            type="search"
            id="main-search"
            class="block w-full p-3 ps-10 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500"
            placeholder="{{ _('館號、物種、採集者、採集號') }}..."
          />
        </div>
        <div class="flex gap-2">
          <button
            type="submit"
            id="search-btn"
            class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-6 py-3"
          >
            {{ _('搜尋') }}
          </button>
          <button
            type="button"
            id="filter-btn"
            class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-3"
            data-drawer-target="drawer-filters"
            data-drawer-toggle="drawer-filters"
            aria-controls="drawer-filters"
          >
            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
            </svg>
            {{ _('進階搜尋') }}
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Results Section -->
  <section id="results-section" class="bg-gray-50 py-8">
    <div class="max-w-screen-xl mx-auto px-4">

      <!-- Results Info -->
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900" id="results-title">{{ _('篩選結果') }}</h2>
        <p id="results-count" class="text-gray-600 mt-1"></p>
      </div>

      <!-- Tabs Navigation -->
      <div class="mb-4 border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px text-sm font-medium" id="default-tab" data-tabs-toggle="#default-tab-content" role="tablist">
          <li class="me-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="datatable-tab"
              data-tabs-target="#datatable"
              type="button"
              role="tab"
              aria-controls="datatable"
            >
              {{ _('表格') }}
            </button>
          </li>
          <li class="me-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
              id="list-tab"
              data-tabs-target="#list"
              type="button"
              role="tab"
              aria-controls="list"
            >
              {{ _('條列') }}
            </button>
          </li>
          <li class="me-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
              id="gallery-tab"
              data-tabs-target="#gallery"
              type="button"
              role="tab"
              aria-controls="gallery"
            >
              {{ _('相簿') }}
            </button>
          </li>
          <li class="me-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
              id="map-tab"
              data-tabs-target="#map"
              type="button"
              role="tab"
              aria-controls="map"
              disabled
            >
              {{ _('地圖') }}
            </button>
          </li>
        </ul>
      </div>

      <!-- Tab Panels -->
      <div id="default-tab-content">

        <!-- DataTable View -->
        <div class="hidden p-4 rounded-lg bg-white" id="datatable" role="tabpanel" aria-labelledby="datatable-tab">
          <div id="grid-wrapper"></div>
        </div>

        <!-- List View -->
        <div class="hidden p-4 rounded-lg bg-white" id="list" role="tabpanel" aria-labelledby="list-tab">
          <div class="space-y-4" id="list-wrapper">
            <template id="list-template">
              <article class="flex items-start space-x-6 p-6 bg-white rounded-lg shadow-sm border border-gray-200">
                <img class="h-32 w-32 object-cover rounded-lg list-view-image" src="" alt="">
                <div class="flex-1">
                  <div class="flex flex-col justify-center h-full space-y-2">
                    <div>
                      <h3 class="text-xl font-bold text-gray-900 italic list-view-scientific-name"></h3>
                      <p class="text-gray-600 list-view-common-name"></p>
                    </div>
                    <div class="flex items-center flex-wrap gap-2 text-sm">
                      <span class="font-mono bg-gray-100 px-2 py-0.5 rounded-md list-view-accession-number"></span>
                      <span class="text-gray-700 list-view-gathering"></span>
                      <time class="text-gray-500 list-view-collect-date"></time>
                    </div>
                    <p class="text-gray-700 text-sm list-view-locality"></p>
                    <div class="flex justify-end">
                      <a href="#" class="text-green-600 hover:text-green-800 font-semibold text-sm list-view-link">
                        {{ _('詳細') }} &rarr;
                      </a>
                    </div>
                  </div>
                </div>
              </article>
            </template>
          </div>
        </div>

        <!-- Gallery View -->
        <div class="hidden p-4 rounded-lg bg-white" id="gallery" role="tabpanel" aria-labelledby="gallery-tab">
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="gallery-wrapper">
            <template id="gallery-template">
              <div class="rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                <a href="" class="gallery-view-link">
                  <img class="h-auto w-full object-cover gallery-view-image" src="" alt="">
                </a>
              </div>
            </template>
          </div>
        </div>

        <!-- Map View -->
        <div class="hidden p-4 rounded-lg bg-white" id="map" role="tabpanel" aria-labelledby="map-tab">
          <div id="result-map-wrapper">
            <div id="result-map"></div>
          </div>
        </div>

      </div>
    </div>
  </section>

</main>
{% include "_inc_filters_drawer.html" %}
{% endblock %}

