{% extends "base.html" %}

{% block script %}
{#<script src="{{ url_for('static', filename='js/data-search.js' ) }}"/></script>#}
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<script>
 document.addEventListener('DOMContentLoaded', function () {

   const gridWrapper = document.getElementById('grid-wrapper');
   const listWrapper = document.getElementById('list-wrapper');
   const galleryWrapper = document.getElementById('gallery-wrapper');
   const listTemplate = document.querySelector('#list-template');
   const galleryTemplate = document.querySelector('#gallery-template');
   const resultsCount = document.getElementById('results-count');
   const searchButton = document.getElementById('search-btn');
   const filterButton = document.getElementById('filter-btn');
   const mainSearch = document.getElementById('main-search');

   // drawer-filter
   const filterForm = document.getElementById('filter-form');
   const applyFilterButton = document.getElementById('apply-filter-btn');

   let searchParams = new URLSearchParams(document.location.search);
   let q = searchParams.get('q');
   if (q !== '') {
     mainSearch.value = q;
   }

   applyFilterButton.onclick = (e) => {
     e.preventDefault();
     applyFilter();
   }

   searchButton.onclick = (e) => {
     e.preventDefault();
     //payload.q = mainSearch.value;
     applyFilter();
   };

   // === config grid ===
   const baseUrl = new URL(`{{ SEARCH_API_URL }}/api/v1/search`);
   let url = baseUrl.toString();
   if (searchParams.has('q')) {
     let data = {
       q: searchParams.get('q'),
     }
     url = `${url}?filter=${JSON.stringify(data)}`;
   }
   let serverConfig = {
     headers: {
       'Content-Type': 'application/json',
     },
     url: url,
     then: (resp) => {
       fetchedRows = [...resp.data];
       listWrapper.innerHTML = '';
       galleryWrapper.innerHTML = '';
       console.log(resp);
       resultsCount.textContent = `顯示第 1 到第 ${resp.data.length} 筆，共 ${resp.total} 筆資料 (${resp.elapsed.toFixed(4)} 秒)`;
       return resp.data.map( (row, index)  => {
         const clone = listTemplate.content.cloneNode(true);
         const clone2 = galleryTemplate.content.cloneNode(true);
         let listViewScientificName = clone.querySelector('.list-view-scientific-name');
         let listViewCommonName = clone.querySelector('.list-view-common-name');
         let listViewGathering = clone.querySelector('.list-view-gathering');
         let listViewAccessionNumber = clone.querySelector('.list-view-accession-number');
         let listViewCollectDate = clone.querySelector('.list-view-collect-date');
         let listViewLocality = clone.querySelector('.list-view-locality');
         let listViewImage = clone.querySelector('.list-view-image');
         let listViewLink = clone.querySelector('.list-view-link');
         let galleryViewImage = clone2.querySelector('.gallery-view-image');
         let galleryViewLink = clone2.querySelector('.gallery-view-link');

         listViewScientificName.textContent = (row.taxon) ? row.taxon.full_scientific_name : '';
         listViewCommonName.textContent = (row.taxon) ? row.taxon.common_name : '';
         listViewGathering.textContent = `${row.collector ? row.collector.display_name : ''} ${row.field_number}`;
         let localityList = row.named_areas.map( x => (x.display_name))
         if (row.locality_text) {
           localityList.push(row.locality_text);
         }
         listViewLocality.textContent = localityList.join(' ∙ ');
         listViewCollectDate.textContent = row.collect_date;
         listViewAccessionNumber.textContent = `HAST:${row.accession_number}`;
         listViewImage.setAttribute('alt', `HAST:${row.accession_number}`);
         if (row.image_url) {
           listViewImage.src = row.image_url;
           galleryViewImage.src = row.image_url;
         }
         listViewLink.href = row.link;
         galleryViewImage.setAttribute('alt', `HAST:${row.accession_number}`);
         galleryViewLink.href = row.link;
         listWrapper.appendChild(clone);
         galleryWrapper.appendChild(clone2);

         return {
           //id: row.record_key,
           image_url: row.image_url || '',
           accession_number: row.accession_number,
           collector: (row.collector) || '',
           field_number: row.field_number,
           taxon: (row.taxon) ? row.taxon : {},
           collect_date: row.collect_date,
           locality: localityList.join(' ∙ '),
           link: row.link,
         }
       });
     },
     total: (resp) =>  resp.total,
     handle: (res) => {
       // no matching records found
       if (res.status === 404) return {data: []};
       if (res.ok) return res.json();
       throw Error('oh no :(');
     },
   }; // end of serverConfig
   let limit = 50;
   let columnsConfig = [
     {id: 'image_url', name: '{{ _("標本照") }}', formatter: (cell) => {
       if (cell) {
         return gridjs.html(`<img src="${cell.replace('-m.jpg', '-s.jpg')}" width="45px" />`);
       }
     }, sort: false},
     {id: 'accession_number', name: '{{ _("館號") }}', formatter: (cell) => {
       return gridjs.html(`<strong>${cell}</strong>`);
     }},
     {id: 'taxon', name: '{{ _("物種") }}', formatter: (cell) => {
       return gridjs.html(`${cell.full_scientific_name || ''}<br /><span class="text-gray-600">${cell.common_name || ''}</span>`);
     }, sort: false},
     {id: 'collector', name: '{{ _("採集者") }}', formatter: (cell) => {
       return gridjs.html(`${cell.full_name_en || ''}<br /><span class="text-gray-600">${cell.full_name || ''}</span>`);
     }},
     {id: 'field_number', name: '{{ _("採集號") }}'},
     {id: 'collect_date', name: '{{ _("採集日期") }}'},
     {id: 'locality', name: '{{ _("採集地點") }}', sort: false},
     {id: 'link', name: '{{ _("連結") }}', sort: false, formatter: (cell, row) => {
       return gridjs.html(`<a href="${cell}" class="text-green-600 hover:text-green-800 font-semibold text-sm">{{ _('連結') }}</a>`);
     }},
   ];

   let gridConfig = {
     server: serverConfig,
     columns: columnsConfig,
     resizable: true,
     pagination: {
       enabled: true,
       limit: limit,
       server: {
         url: (prev, page, limit) => {
           return `${prev}${prev.includes('?') ? '&' : '?'}range=${JSON.stringify([page * limit, (page + 1 ) * limit])}`;
         },
       }
     },
     sort: {
       multiColumn: false,
       server: {
         url: (prev, cols) => {
           //console.log(prev, cols, typeof(prev));
           if (!cols.length) return prev;

           const col = cols[0];
           let field = columnsConfig[col.index].id;
           field = (col.direction === 1) ? field : `-${field}`;
           return `${prev}${prev.includes('?') ? '&' : '?'}sort=${JSON.stringify([field])}`;
         }
       }
     },
   };
   /*
     gridConfig.search = {
       debounceTimeout: 400,
       server: {
         url: (prev, q) => {
           return `${prev}${prev.includes('?') ? '&' : '?'}filter=${JSON.stringify({'q':q})}`;
         }
       }
     };
   */
   const grid  = new gridjs.Grid(gridConfig).render(gridWrapper);

   const getFormData = () => {
     const formData = new FormData(filterForm);
     let data = {};
     for (const [key, value] of formData) {
       if (value) {
         if (['species', 'genus', 'family', 'adm1', 'adm2', 'adm3'].indexOf(key) < 0) {
           data[key] = value;
         }
       }
     }

     // taxon_id
     const taxa = ['species', 'genus', 'family'];
     for(let i=0; i<taxa.length; i++) {
       if (formData.has(taxa[i]) && formData.get(taxa[i])) {
         data.taxon_id = formData.get(taxa[i]);
         break;
       }
     }
     // named_area_id
     const namedAreas = ['adm3', 'adm2', 'adm1'];
     for(let i=0; i<namedAreas.length; i++) {
       if (formData.has(namedAreas[i]) && formData.get(namedAreas[i])) {
         data.named_area_id = formData.get(namedAreas[i]);
         break;
       }
     }

     return data;
   };

   const applyFilter = () => {
     resultsCount.innerHTML = '--';
     document.getElementById('results-title').textContent = 'Loading...';
     let data = getFormData();
     if (mainSearch.value !== '') {
       data.q = mainSearch.value;
     }
     //alert(JSON.stringify(data, null, 2));
     if (Object.keys(data).length) {
       filterButton.classList.remove('bg-white', 'hover:bg-gray-50');
       filterButton.classList.add('bg-purple-700', 'hover:bg-purple-800', 'text-white');
     } else {
       filterButton.classList.remove('bg-purple-700', 'hover:bg-purple-800', 'text-white');
       filterButton.classList.add('bg-white', 'hover:bg-gray-50');
     }
     //q
     let url = `${baseUrl}?filter=${JSON.stringify(data)}`;
     grid.updateConfig({
       server: {
         ...serverConfig,
         url: url,
       }
     }).forceRender();
   };
 });
</script>
{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
{% endblock %}

{% block main %}
<main class="pt-16">
  <!-- Compact Search Section -->
  <section class="bg-white dark:bg-gray-900 py-8 border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-screen-xl mx-auto px-4">
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ _('標本搜尋') }}{#Search Specimens#}</h1>
        <p class="text-gray-600 dark:text-gray-400">{{ _('探索數位化自然史典藏資料') }}{#Search through digitized herbarium specimens from collections worldwide#}</p>
      </div>

      <form id="search-form" class="flex flex-col lg:flex-row gap-4">
        <div class="relative flex-1">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <input type="search" class="block w-full p-3 ps-10 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500" placeholder="{{ _('館號、物種、採集者、採集號') }}...{#Search by species, collector, or location#}..." id="main-search"/>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-6 py-3 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800" id="search-btn">{{ _('搜尋') }}</button>
          <button type="button" class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-3 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-700" data-drawer-target="drawer-filters" data-drawer-show="drawer-filters" aria-controls="drawer-filters" id="filter-btn">
            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
            </svg>
            {{ _('進階搜尋') }}{#Filters#}
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- DataTable Results Section -->
  <section id="results-section" class="py-12 bg-white dark:bg-gray-900">
    <div class="max-w-screen-xl mx-auto px-4">
      <!-- Results Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white" id="results-title">{{ _('篩選結果') }}</h2>
          <p id="results-count" class="text-gray-600 dark:text-gray-400">{#Showing 1 to 8 of 8 entries#}</p>
        </div>
        {#
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
          <!-- Entries per page -->
          <div class="flex items-center space-x-2">
            <label for="entries-select" class="text-sm text-gray-700 dark:text-gray-300">Show:</label>
            <select id="entries-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500">
              <option>10</option>
              <option>25</option>
              <option>50</option>
              <option>100</option>
            </select>
            <span class="text-sm text-gray-700 dark:text-gray-300">entries</span>
          </div>
          <!-- Search within results -->
          <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <input type="search" id="table-search" class="block p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-64 bg-gray-50 focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-green-500 dark:focus:border-green-500" placeholder="Search within results...">
          </div>
        </div>
        #}
      </div>
      {# tabs #}
      <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="default-tab" data-tabs-toggle="#default-tab-content" role="tablist">
          <li class="me-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg" id="datatable-tab" data-tabs-target="#datatable" type="button" role="tab" aria-controls="datatable" aria-selected="false">{{ _('表格') }}</button>
          </li>
          <li class="me-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="list-tab" data-tabs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="false">{{ _('條列') }}</button>
          </li>
          <li class="me-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="gallery-tab" data-tabs-target="#gallery" type="button" role="tab" aria-controls="gallery" aria-selected="false">{{ _('相簿') }}</button>
          </li>
          <li class="me-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300" id="map-tab" data-tabs-target="#map" type="button" role="tab" aria-controls="map" aria-selected="false">{{ _('地圖') }}</button>
          </li>
        </ul>
      </div>
      <div id="default-tab-content">
        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="datatable" role="tabpanel" aria-labelledby="data-tab">
          <div id="grid-wrapper"></div>
        </div>
        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="list" role="tabpanel" aria-labelledby="list-tab">
          <div class="space-y-4" id="list-wrapper">
            <template id="list-template">
              <article class="flex items-start space-x-6 p-6 bg-white dark:bg-gray-900 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                <img class="h-32 object-cover rounded-lg list-view-image" src="" alt="">
                <div class="flex-1">
                  <div class="flex flex-col justify-center h-full">
                    <div class="font-semibold text-gray-800 text-base">
                      <span class="mb-2 text-xl font-bold text-gray-900 dark:text-white list-view-scientific-name"></span>
                      <span class="text-gray-600 list-view-common-name"></span>
                    </div>
                    <div class="flex items-center text-gray-500 mt-1">
                      <span class="font-mono bg-gray-100 px-2 py-0.5 rounded-md mr-2 list-view-accession-number"></span>
                      <span class="text-gray-700 list-view-gathering"></span>
                      <time class="ml-4 text-gray-500 dark:text-gray-400 list-view-collect-date"></time>
                    </div>
                    <div class="text-gray-700 list-view-locality"></div>
                    <div class="flex justify-between items-center">
                      <div></div>
                      <a href="#" class="text-green-600 hover:text-green-800 font-semibold text-sm list-view-link">{{ _('詳細') }}{#Read Detail#} &rarr;</a>
                    </div>

                  </div>
                </div>
              </article>
            </template>
          </div>
        </div>
        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="gallery" role="tabpanel" aria-labelledby="gallery-tab">
          <template id="gallery-template">
            <div>
              <a href="" class="gallery-view-link"><img class="h-auto max-w-full rounded-lg gallery-view-image" src="" alt=""></a>
            </div>
          </template>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="gallery-wrapper">
          </div>
        </div>
        <div class="hidden p-4 rounded-lg bg-gray-50 dark:bg-gray-800" id="map" role="tabpanel" aria-labelledby="map-tab">
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="map-wrapper">
            map view
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
{#
<!-- Main modal -->
<div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-2xl max-h-full">
        <div class="relative bg-white rounded-lg shadow">
            <div class="flex items-center justify-between p-4 border-b rounded-t">
                <h3 class="text-xl font-semibold text-gray-900">
                    Terms of Service
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="default-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <p class="text-base leading-relaxed text-gray-500">
                    Your modal content goes here.
                </p>
            </div>
        </div>
    </div>
</div>
#}
{% include "_inc_filters_drawer.html" %}
{% endblock %}

